---
title: Kubernetes EFK
date: YYYY-MM-DD HH:MM:SS +09:00
categories: [ë°±ì—”ë“œ, k8s]
tags:
  [
    ë°±ì—”ë“œ,
    k8s,
    Elastic,
    Fluentd,
    Kibana,
    EFK
  ]

toc: true
toc_sticky: true

---

# Kubernetes EFK

# EFK Stackì´ë€?

**EFK(Elasticsearch, Fluentd and Kibana):** Kubernetes ë¡œê·¸ ì§‘ê³„ ë° ë¶„ì„ì„ ìœ„í•œ ì¸ê¸° ìˆëŠ” ìµœê³ ì˜ ì˜¤í”ˆ ì†ŒìŠ¤ì…ë‹ˆë‹¤.

## 1. Elasticsearch

- ì¼ë°˜ì ìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” í™•ì¥ ê°€ëŠ¥í•œ **ë¶„ì‚° ê²€ìƒ‰ ì—”ì§„**ìœ¼ë¡œì¨ ëŒ€ëŸ‰ì˜ ë¡œê·¸ ë°ì´í„°ë¥¼ ì„ ë³„
- Lucene ê²€ìƒ‰ ì—”ì§„(Apacheì˜ ê²€ìƒ‰ ë¼ì´ë¸ŒëŸ¬ë¦¬)ì„ ê¸°ë°˜ìœ¼ë¡œ í•˜ëŠ” NoSQL ë°ì´í„° ë² ì´ìŠ¤
- ë¡œê·¸ë¥¼ ì €ì¥í•˜ê³  fluentdì—ì„œ ë¡œê·¸ë¥¼ ê²€ìƒ‰

## 2. Fluentd

> Kubernetesì˜ ê²½ìš° Fluentdê°€ ì¶”ê°€ êµ¬ì„± ì—†ì´ ì»¨í…Œì´ë„ˆ ë¡œê·¸ë¥¼ êµ¬ë¬¸ ë¶„ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


- Fluentd is a log shipper
- ë‹¤ì¤‘ ë°ì´í„° ì†ŒìŠ¤ ë° ì¶œë ¥ í˜•ì‹ì„ ì§€ì›í•˜ëŠ” ì˜¤í”ˆ ì†ŒìŠ¤ ìœ í˜•ì˜ **ë¡œê·¸ ìˆ˜ì§‘ ì—ì´ì „íŠ¸**
- ë˜í•œ Stackdriver, Cloudwatch, elasticsearch, Splunk, Bigquery ë“±ê³¼ ê°™ì€ ì†”ë¥˜ì…˜ìœ¼ë¡œ ë¡œê·¸ë¥¼ ì „ë‹¬
- ë¡œê·¸ ë°ì´í„°ë¥¼ ìƒì„±í•˜ëŠ” ì‹œìŠ¤í…œê³¼ ë¡œê·¸ ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ì‹œìŠ¤í…œ ê°„ì˜ í†µí•© ê³„ì¸µ

## 3. Kibana

> ElasticsearchëŠ” ë°©ëŒ€í•œ ì–‘ì˜ ë¹„ì •í˜• ë°ì´í„°ë¥¼ ë¶„ë¦¬í•˜ëŠ” ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ”ë° ë„ì›€ì´ ë˜ë©° ë§ì€ ì¡°ì§ì—ì„œ ì‚¬ìš©ë˜ê³  ìˆìŠµë‹ˆë‹¤. ElasticsearchëŠ” ì¼ë°˜ì ìœ¼ë¡œ Kibanaì™€ í•¨ê»˜ ë°°í¬ë©ë‹ˆë‹¤.


- **ì¿¼ë¦¬, ë°ì´í„° ì‹œê°í™” ë° ëŒ€ì‹œë³´ë“œë¥¼ ìœ„í•œ UI ë„êµ¬**
- ì›¹ ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ ë¡œê·¸ ë°ì´í„°ë¥¼ íƒìƒ‰í•˜ê³ , ì´ë²¤íŠ¸ ë¡œê·¸ì— ëŒ€í•œ ì‹œê°í™”ë¥¼ êµ¬ì¶•
- ë¬¸ì œë¥¼ ê°ì§€í•˜ê¸° ìœ„í•´ ì •ë³´ë¥¼ í•„í„°ë§í•˜ëŠ” ì¿¼ë¦¬ë³„ ì¿¼ë¦¬ ì—”ì§„
- Kibanaë¥¼ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  ìœ í˜•ì˜ ëŒ€ì‹œë³´ë“œë¥¼ ê°€ìƒìœ¼ë¡œ êµ¬ì¶• ê°€ëŠ¥
- KQL(Kibana Query Language)ì€ Elasticsearch ë°ì´í„°ë¥¼ ì¿¼ë¦¬í•˜ëŠ”ë° ì‚¬ìš©

# EFK ì•„í‚¤í…ì²˜

![Untitled](/assets/img/2024-10-49/Untitled.png)

1. ëª¨ë“  ë…¸ë“œì—ì„œ ì»¨í…Œì´ë„ˆ ë¡œê·¸ë¥¼ ìˆ˜ì§‘í•´ì•¼ í•˜ë¯€ë¡œ daemonsetìœ¼ë¡œ ë°°í¬ Elasticsearch ì„œë¹„ìŠ¤ ì—”ë“œí¬ì¸íŠ¸ì— ì—°ê²°í•˜ì—¬ ë¡œê·¸ë¥¼ ì „ë‹¬
2. ë¡œê·¸ ë°ì´í„°ë¥¼ ë³´ìœ í•˜ê³  ìˆìœ¼ë¯€ë¡œ statefulsetë¡œ ë°°í¬ Fluentd ë° Kibanaì— ì—°ê²°í•  ì„œë¹„ìŠ¤ ì—”ë“œí¬ì¸íŠ¸ ë…¸ì¶œ
3. Deploymentë¡œ ë°°í¬ë˜ê³  elasticsearch ì„œë¹„ìŠ¤ ì—”ë“œí¬ì¸íŠ¸ì— ì—°ê²°

```
git clone https://github.com/scriptcamp/kubernetes-efk
```

# EFK ì‹¤ìŠµ

## Deploy Elasticsearch Service

ğŸ’¡ elasticsearch ê²€ìƒ‰ì„ ìœ„í•œ **ì„œë¹„ìŠ¤** ìƒì„±


```
kubectl create -f es-svc.yaml
```

![Untitled](/assets/img/2024-10-49/Untitled%201.png)

## Deploy Elasticsearch Statefulset

- elasticsearch ê²€ìƒ‰ì„ ìœ„í•œ statefulset ìƒì„±ì„ ì‹œì‘í•˜ê¸° ì „ì— **statefulset** ì—ëŠ” í•„ìš”í•  ë•Œë§ˆë‹¤ ë³¼ë¥¨ì„ ìƒì„±í•  ìˆ˜ ìˆëŠ” ì‚¬ì „ ì •ì˜ëœ ìŠ¤í† ë¦¬ì§€ í´ë˜ìŠ¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.
- í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” 400~500Gbsì´ í•„ìš”í•˜ì§€ë§Œ ì—¬ê¸°ì„œëŠ” 3Gb PVCë¥¼ ì‚¬ìš©í•˜ì—¬ ë°°í¬í•©ë‹ˆë‹¤.
- PVC (Persistance Volumn Claim)ì€ PVë¡œ ë³¼ë¥¨ì„ ìš”ì²­í•˜ê³  ë°”ì¸ë”©í•˜ì—¬ í• ë‹¹í•©ë‹ˆë‹¤.

```jsx
kubectl create -f es-sts.yaml
```

![Untitled](/assets/img/2024-10-49/Untitled%202.png)

## Deploy Kibana Deployment

- Kubernetes **deployment**ë¡œ **Kibana** ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³ , Kibana ë°°í¬ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ì„ í™•ì¸í•˜ë©´ Elasticsearch í´ëŸ¬ìŠ¤í„° ì—”ë“œí¬ì¸íŠ¸ë¥¼ êµ¬ì„±í•˜ê¸° ìœ„í•´ env var **ELASTICSEARCH_URL** ì´ ì •ì˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
- KibanaëŠ” ì—”ë“œí¬ì¸íŠ¸ URLì„ ì‚¬ìš©í•˜ì—¬ Elasticsearchì— ì—°ê²°í•©ë‹ˆë‹¤.

```
kubectl create -f kibana-deployment.yaml
```

![Untitled](/assets/img/2024-10-49/Untitled%203.png)

## Deploy Kibana Service

```
kubectl create -f kibana-svc.yaml
```

![Untitled](/assets/img/2024-10-49/Untitled%204.png)

- kubectl get podsë¥¼ ì‹¤í–‰í•˜ê³  kibana íŒŒë“œì´ë¦„ìœ¼ë¡œ í¬íŠ¸ í¬ì›Œë”©ì„ í•©ë‹ˆë‹¤.

```
> kubectl get pods
> kubectl port-forward kibana-7bf5f786b9-q48v5 5601:5601
```

![Untitled](/assets/img/2024-10-49/Untitled%205.png)

- [localhost:5601](http://localhost:5601) ì ‘ì†

![Untitled](/assets/img/2024-10-49/Untitled%206.png)

## Create Fluentd Cluster Role

- kubernetesì˜ í´ëŸ¬ìŠ¤í„° ì—­í• ì—ëŠ” Cluster roleì„ ë‚˜íƒ€ë‚´ëŠ” ê·œì¹™ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
- fluentdì˜ ê²½ìš° **í¬ë“œ ë° ë„¤ì„ìŠ¤í˜ì´ìŠ¤**ì— ëŒ€í•œ **ê¶Œí•œì„ ë¶€ì—¬**í•´ì•¼ í•©ë‹ˆë‹¤.

``` 
kubectl create -f fluentd-role.yaml
```

![Untitled](/assets/img/2024-10-49/Untitled%207.png)

## Create Fluentd Service Account

- kubernetes ì—ì„œ ì„œë¹„ìŠ¤ ê³„ì •ì€ íŒŒë“œì— ì•„ì´ë´í‹°í‹°ë¥¼ ì œê³µí•˜ëŠ” ì—”í‹°í‹°ì…ë‹ˆë‹¤.
- ì—¬ê¸°ì„œëŠ” ********fluentd í¬ë“œì™€ í•¨ê»˜ ì‚¬ìš©í•  ì„œë¹„ìŠ¤ ê³„ì •ì„ ìƒì„±********í•˜ë ¤ê³  í•©ë‹ˆë‹¤.

``` 
kubectl create -f fluentd-sa.yaml
```

![Untitled](/assets/img/2024-10-49/Untitled%208.png)

## Create Fluentd Cluster Role Binding

- kubernetesì˜ ClusterRoleì€ í´ëŸ¬ìŠ¤í„° ì—­í• ì— ì •ì˜ëœ **ê¶Œí•œì„ ì„œë¹„ìŠ¤ ê³„ì •ì— ë¶€ì—¬**í•©ë‹ˆë‹¤.
- ìƒì„±ëœ ì—­í• (fluentd)ê³¼ ì„œë¹„ìŠ¤ ê³„ì •(fluentd) ê°„ì— ì—­í•  ê²°í•©ì„ ìƒì„±í•©ë‹ˆë‹¤.

``` 
kubectl create -f fluentd-rb.yaml
```

![Untitled](/assets/img/2024-10-49/Untitled%209.png)

## Deploy Fluentd DaemonSet

- fluentd ë°ëª¬ ì…‹ì„ ìƒì„±í•©ë‹ˆë‹¤.
- dashboardì—ì„œ ë°ëª¬ ì…‹ ìƒì„±ì„ í™•ì¸í•©ë‹ˆë‹¤.

``` 
kubectl create -f fluentd-ds.yaml
```

![Untitled](/assets/img/2024-10-49/Untitled%2010.png)

- `fluentd-ds.yaml`

![Untitled](/assets/img/2024-10-49/Untitled%2011.png)

- â€œ**FLUENT_ELASTICSEARCH_HOST**â€ ë° â€œ**FLUENT_ELASTICSEARCH_PORT**â€ ë¼ëŠ” ë‘ ê°€ì§€ í™˜ê²½ ë³€ìˆ˜ë¥¼ ì‚¬ìš©
- FluentdëŠ” ì´ëŸ¬í•œ Elasticsearch ê°’ì„ ì‚¬ìš©í•˜ì—¬ ìˆ˜ì§‘ëœ ë¡œê·¸ë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤.

## Verify Fluentd Setup

- fluentd ì„¤ì¹˜ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ ì§€ì†ì ìœ¼ë¡œ ë¡œê·¸ë¥¼ ìƒì„±í•˜ëŠ” í…ŒìŠ¤íŠ¸ í¬ë“œë¥¼ ì‹œì‘
- ê·¸ëŸ° ë‹¤ìŒ Kibana ë‚´ë¶€ì—ì„œ ì´ëŸ¬í•œ ë¡œê·¸ë¥¼ í™•ì¸

``` 
kubectl create -f test-pod.yaml
```

![Untitled](/assets/img/2024-10-49/Untitled%2012.png)

## Kibana ì—°ë™

``` 
kubectl port-forward service/kibana-np 5601:8080
```

![Untitled](/assets/img/2024-10-49/Untitled%2013.png)

- Create index patternì„ í´ë¦­í•˜ì—¬ ë¡œê·¸ íŒ¨í„´ì„ ìƒì„±í•©ë‹ˆë‹¤.

![Untitled](/assets/img/2024-10-49/Untitled%2014.png)

- â€œlogstash-*â€ íŒ¨í„´ì„ ì‚¬ìš©í•˜ì—¬ ìƒˆ ì¸ë±ìŠ¤ íŒ¨í„´ ìƒì„±

![Untitled](/assets/img/2024-10-49/Untitled%2015.png)

- @timestampë¥¼ ì„ íƒí•˜ê³  Create index pattern ë²„íŠ¼ í´ë¦­

![Untitled](/assets/img/2024-10-49/Untitled%2016.png)

- Fluentdì—ì„œ ë‚´ë³´ë‚´ëŠ” ëª¨ë“  ë¡œê·¸ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- counter íŒŒë“œì˜ ë¡œê·¸ í™•ì¸

![Untitled](/assets/img/2024-10-49/Untitled%2017.png)