---
title: SourceDB - Kafka - SinkDB 2 (MySql, Postgres)
date: YYYY-MM-DD HH:MM:SS +09:00
categories: [ë°±ì—”ë“œ, Kafka]
tags:
  [
    ë°±ì—”ë“œ,
    Kafka,
    MySql,
    Postgres
  ]

toc: true
toc_sticky: true

---
# SourceDB - Kafka - SinkDB 2 (MySql, Postgres)

## êµ¬ì„±ë„

![Untitled](/assets/img/2023-10-40-Kafka/Untitled.png)

- **ë¡œì»¬ í™˜ê²½**

## docker compose íŒŒì¼ ìƒì„±

- MySQL(sourceDB), MySQL(sinkDB1), Kafka, Zookeeper, PostgreSQL(sinkDB2) ì´ë¯¸ì§€ë¡œ êµ¬ì„±

``` 
version: '3'
services:
  mysql:
    image: mysql:8.0
    container_name: mysql
    ports:
    - 3308:3306
    environment:
      MYSQL_ROOT_PASSWORD: admin
      MYSQL_USER: mysqluser
      MYSQL_PASSWORD: mysqlpw
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    volumes:
      - C:/mysql/data:/var/lib/mysql
  zookeeper:
    container_name: zookeeper
    image: wurstmeister/zookeeper
    ports:
      - "2181:2181"
    
  kafka:
    container_name: kafka
    image: wurstmeister/kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_ADVERTISED_HOST_NAME: 127.0.0.1
      KAFKA_ADVERTISED_PORT: 9092
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
  
  mysql-sink:
    image: mysql:8.0
    container_name: mysql-sink
    ports:
      - 3307:3306
    environment:
      MYSQL_ROOT_PASSWORD: admin
      MYSQL_USER: mysqluser
      MYSQL_PASSWORD: mysqlpw
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    volumes:
      - C:/mysql-sink/data:/var/lib/mysql

  postgresql:
    image: quay.io/debezium/postgres:9.6
    container_name: postgres-sink
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=postgresuser
      - POSTGRES_PASSWORD=postgrespw
    volumes:
      - C:/postgres/data:/var/lib/postgres
```

``` 
docker-compose -f docker-compose2.yml up -d
```

![Untitled](/assets/img/2023-10-40-Kafka/Untitled%201.png)

## DB Custom í…Œì´ë¸”(users) ìƒì„± ë° ìœ ì € ê¶Œí•œ ë¶€ì—¬

### MySQL(source db)

![Untitled](/assets/img/2023-10-40-Kafka/Untitled%202.png)

![Untitled](/assets/img/2023-10-40-Kafka/Untitled%203.png)

### MySQL(sink db1)

![Untitled](/assets/img/2023-10-40-Kafka/Untitled%204.png)

![Untitled](/assets/img/2023-10-40-Kafka/Untitled%203.png)

### PostgreSQL(sink db2)

postgres ì ‘ì†

![Untitled](/assets/img/2023-10-40-Kafka/Untitled%205.png)

custom_sinkdb ìƒì„± ë° users í…Œì´ë¸” ìƒì„±

![Untitled](/assets/img/2023-10-40-Kafka/Untitled%206.png)

postgresuser ê¶Œí•œ ë¶€ì—¬

![Untitled](/assets/img/2023-10-40-Kafka/Untitled%207.png)

![Untitled](/assets/img/2023-10-40-Kafka/Untitled%208.png)

## Debezium Connector ì„¤ì¹˜ & JDBC Connector ì„¤ì¹˜

connector íŒŒì¼ë“¤ /opt/kafka_2.13-2.8.1/connectors/ë¡œ ë³µì‚¬

``` 
docker cp debezium-connector-mysql-1.9.6.Final-plugin.tar.gz kafka:/opt/kafka_2.13-2.8.1/connectors/debezium-connector-mysql1.9.6.Final-plugin.tar.gz

docker cp confluentinc-kafka-connect-jdbc-10.7.0.zip kafka:/opt/kafka_2.13-2.8.1/connectors/
```

íŒŒì¼ ì••ì¶• í•´ì œ

![Untitled](/assets/img/2023-10-40-Kafka/Untitled%209.png)

## connect-distributed.properties ìˆ˜ì •

plugin ê²½ë¡œ ì„¤ì •

![Untitled](/assets/img/2023-10-40-Kafka/Untitled%2010.png)

![Untitled](/assets/img/2023-10-40-Kafka/Untitled%2011.png)

## Kafka ì‹¤í–‰

``` 
connect-distributed.sh /opt/kafka/config/connect-distributed.properties
```

![Untitled](/assets/img/2023-10-40-Kafka/Untitled%2012.png)

í¬íŠ¸ í™•ì¸

![Untitled](/assets/img/2023-10-40-Kafka/Untitled%2013.png)

ì»¤ë„¥í„° í”ŒëŸ¬ê·¸ì¸ í™•ì¸

![Untitled](/assets/img/2023-10-40-Kafka/Untitled%2014.png)

## ì»¤ë„¥í„° ì„¤ì • ë° ìƒì„±

### source-custom-connector

```jsx
curl --location --request POST 'http://localhost:8083/connectors' \
--header 'Content-Type: application/json' \
--data '{
"name": "source-custom-connector",
"config": {
"connector.class": "io.debezium.connector.mysql.MySqlConnector",
"tasks.max": "1",
"database.hostname": "mysql",
"database.port": "3306",
"database.user": "mysqluser",
"database.password": "mysqlpw",
"database.server.id": "184054",
"database.server.name": "dbserver1",
"database.allowPublicKeyRetrieval": "true",
"database.include.list": "sourcedb",
"database.history.kafka.bootstrap.servers": "kafka:9092",
"database.history.kafka.topic": "dbhistory.sourcedb",
"key.converter": "org.apache.kafka.connect.json.JsonConverter",
"key.converter.schemas.enable": "true",
"value.converter": "org.apache.kafka.connect.json.JsonConverter",
"value.converter.schemas.enable": "true",
"transforms": "unwrap,addTopicPrefix",
"transforms.unwrap.type": "io.debezium.transforms.ExtractNewRecordState",
"transforms.unwrap.drop.tombstones": "false",
"transforms.unwrap.delete.handling.mode":"rewrite" ,
"transforms.addTopicPrefix.type":"org.apache.kafka.connect.transforms.RegexRouter",
"transforms.addTopicPrefix.regex":"(.*)",
"transforms.addTopicPrefix.replacement":"$1",
"include.schema.changes": "true"
}
}'
```

- Debezium MySQL ì»¤ë„¥í„° ì‚¬ìš©
- MySQL Souce DB ì„¤ì •
- í† í”½ ì„¤ì •
- value ë³€í™˜ì— JsonConverterë¥¼ ì‚¬ìš©

<aside>
ğŸ’¡ ì˜¤ë¥˜ ë°œìƒ - Delete, Alter ì ìš© ì•ˆë¨

</aside>

```jsx
"transforms.unwrap.drop.tombstones": "false",
"transforms.unwrap.delete.handling.mode":"rewrite",
"include.schema.changes": "true"
```

- **`transforms.unwrap.drop.tombstones`**: ë ˆì½”ë“œê°€ ì‚­ì œë˜ì—ˆì„ ë•Œ í•´ë‹¹ ë ˆì½”ë“œë¥¼ ë¬´ì‹œí• ì§€ ì—¬ë¶€
- **`transforms.unwrap.delete.handling.mode`**: ë ˆì½”ë“œê°€ ì‚­ì œë˜ì—ˆì„ ë•Œ ì²˜ë¦¬ ë°©ë²•
- **`sourcedb`** ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë³€ê²½ ì‚¬í•­ì„ ì¶”ì í•˜ì—¬ **`dbserver1`**ì´ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ Kafka í† í”½ì— ì „ì†¡í•©ë‹ˆë‹¤.
- **`transforms`** ì„¤ì •ì„ ì‚¬ìš©í•˜ì—¬ Kafka í† í”½ ì´ë¦„ì„ **`sourcedb.<table-name>`**í˜•ì‹ìœ¼ë¡œ ë³€ê²½í•©ë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ì¶”ì  ì¤‘ì¸ í…Œì´ë¸” ì´ë¦„ìœ¼ë¡œ êµ¬ë¶„ëœ Kafka í† í”½ì„ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- **`"include.schema.changes": "true"`** ë¥¼ ì„¤ì •í•˜ë©´, í•´ë‹¹ ì»¤ë„¥í„°ëŠ” ìŠ¤í‚¤ë§ˆ ë³€í™”ë¥¼ ê°ì§€í•˜ê³  ëŒ€ì‘í•˜ëŠ” ALTER TABLE ë¬¸ì„ ìë™ìœ¼ë¡œ ìƒì„±í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ì— ë°˜ì˜í•˜ê²Œ ë©ë‹ˆë‹¤.
- source-custom-connector ë“±ë¡ í™•ì¸

![Untitled](/assets/img/2023-10-40-Kafka/Untitled%2015.png)

<aside>
ğŸ’¡ Kafka ì˜¤ë¥˜ ë°œìƒ

</aside>

```jsx
NO Suitable driber found for jdbc:mysql://mysql-sink:3306/sinkdb?user=mysqluser&password=mysqlpw
```

![Untitled](/assets/img/2023-10-40-Kafka/Untitled%2016.png)

1. mysql-connector-java íŒŒì¼ì„ ë‹¤ìš´ë°›ëŠ”ë‹¤.
2. í•´ë‹¹ jar íŒŒì¼ì„ Confluentì˜ connect í”ŒëŸ¬ê·¸ì¸ì´ ì„¤ì¹˜ëœ ë””ë ‰í† ë¦¬ì— ë„£ëŠ”ë‹¤.
    
    ![Untitled](/assets/img/2023-10-40-Kafka/Untitled%2017.png)
    

### sink-custom-connector1

```jsx
curl --location --request POST 'http://localhost:8083/connectors' \
--header 'Content-Type: application/json' \
--data '{
"name": "sink-custom-connector1",
"config": {
"connector.class": "io.confluent.connect.jdbc.JdbcSinkConnector",
"tasks.max": "1",
"connection.url": "jdbc:mysql://mysql-sink:3307/custom_sinkdb?user=mysqluser&password=mysqlpw",
"auto.create": "false",
"auto.evolve": "true",
"delete.enabled": "true",
"insert.mode": "upsert",
"pk.mode": "record_key",
"table.name.format":"${topic}",
"tombstones.on.delete": "true",
"connection.user": "mysqluser",
"connection.password": "mysqlpw",
"topics.regex": "dbserver1.sourcedb.(.*)",
"key.converter": "org.apache.kafka.connect.json.JsonConverter",
"key.converter.schemas.enable": "true",
"value.converter": "org.apache.kafka.connect.json.JsonConverter",
"value.converter.schemas.enable": "true",
"transforms": "unwrap, route, TimestampConverter",
"transforms.unwrap.type": "io.debezium.transforms.ExtractNewRecordState",
"transforms.unwrap.drop.tombstones": "false",
"transforms.unwrap.delete.handling.mode":"rewrite" ,
"transforms.route.type": "org.apache.kafka.connect.transforms.RegexRouter",
"transforms.route.regex": "([^.]+)\\.([^.]+)\\.([^.]+)",
"transforms.route.replacement": "$3",
"transforms.TimestampConverter.type": "org.apache.kafka.connect.transforms.TimestampConverter$Value",
"transforms.TimestampConverter.format": "yyyy-MM-dd HH:mm:ss",
"transforms.TimestampConverter.target.type": "Timestamp",
"transforms.TimestampConverter.field": "update_date",
"include.schema.changes": "true"
}
}'
```

- Kafka Connectì—ì„œ MySQL ë¸Œë¡œì»¤ë¡œ ë°ì´í„°ë¥¼ ì „ì†¡í•˜ëŠ” JDBC Sink Connectorë¥¼ êµ¬ì„±
- MySQL Sink DB ì„¤ì •
- **`delete.enabled`** : ì‚­ì œëœ ë ˆì½”ë“œë¥¼ Sinkì— ì“¸ì§€ ì—¬ë¶€ë¥¼ ê²°ì •í•©ë‹ˆë‹¤. ì´ë¥¼ trueë¡œ ì„¤ì •í•˜ì—¬ ì‚­ì œëœ ë ˆì½”ë“œë„ Sinkì— ì“°ë„ë¡ í•©ë‹ˆë‹¤.
- **`tombstones.on.delete`** : ì‚­ì œ ì‹œ í† í”½ì— ë¹ˆ ë©”ì‹œì§€ë¥¼ ì‘ì„±í•˜ëŠ” ì˜µì…˜ì…ë‹ˆë‹¤. ì´ë¥¼ trueë¡œ ì„¤ì •í•˜ì—¬ ë ˆì½”ë“œ ì‚­ì œ ì‹œ ë¹ˆ ë©”ì‹œì§€ê°€ ì‘ì„±ë˜ë„ë¡ í•©ë‹ˆë‹¤.
- sink-custom-connector1 ë“±ë¡ ë° ì„¤ì • í™•ì¸

![Untitled](/assets/img/2023-10-40-Kafka/Untitled%2018.png)

### sink-custom-connector2

```jsx
curl --location --request POST 'http://localhost:8083/connectors' \
--header 'Content-Type: application/json' \
--data '{
"name": "sink-custom-connector2",
"config": {
"connector.class": "io.confluent.connect.jdbc.JdbcSinkConnector",
"tasks.max": "1",
"connection.url": "jdbc:postgresql://postgres-sink:5432/custom_sinkdb?user=postgresuser&password=postgrespw",
"auto.create": "false",
"auto.evolve": "true",
"delete.enabled": "true",
"insert.mode": "upsert",
"pk.mode": "record_key",
"table.name.format":"${topic}",
"tombstones.on.delete": "true",
"connection.user": "postgresuser",
"connection.password": "postgrespw",
"topics.regex": "dbserver1.sourcedb.(.*)",
"key.converter": "org.apache.kafka.connect.json.JsonConverter",
"key.converter.schemas.enable": "true",
"value.converter": "org.apache.kafka.connect.json.JsonConverter",
"value.converter.schemas.enable": "true",
"transforms": "unwrap, route, TimestampConverter",
"transforms.unwrap.type": "io.debezium.transforms.ExtractNewRecordState",
"transforms.unwrap.drop.tombstones": "false",
"transforms.unwrap.delete.handling.mode":"rewrite" ,
"transforms.route.type": "org.apache.kafka.connect.transforms.RegexRouter",
"transforms.route.regex": "([^.]+)\\.([^.]+)\\.([^.]+)",
"transforms.route.replacement": "$3",
"transforms.TimestampConverter.type": "org.apache.kafka.connect.transforms.TimestampConverter$Value",
"transforms.TimestampConverter.format": "yyyy-MM-dd HH:mm:ss",
"transforms.TimestampConverter.target.type": "Timestamp",
"transforms.TimestampConverter.field": "update_date",
"include.schema.changes": "true"
}
}'
```

- Kafka Connectì—ì„œ Postgres ë¸Œë¡œì»¤ë¡œ ë°ì´í„°ë¥¼ ì „ì†¡í•˜ëŠ” JDBC Sink Connector êµ¬ì„±
- PostgreSQL Sink DB ì„¤ì •
- sink-custom-connector1ê³¼ ê°™ìŒ
- sink-custom-connector2 ìƒì„± & ì„¤ì • í™•ì¸

![Untitled](/assets/img/2023-10-40-Kafka/Untitled%2019.png)

## Kafka ë™ì‘ ì˜ìƒ

[Kafka ë™ì‘ ì˜ìƒ.mp4](https://www.notion.so/tomy8964/SourceDB-Kafka-SinkDB-2-4c7d075fa5884911afbb85fec159c853?pvs=4#af97a788143e461bb1c9f843b6ddde41)

## ë°ì´í„° ì‚½ì…

### Source_DB(MySQL)ì— ë°ì´í„° ì‚½ì…

![Untitled](/assets/img/2023-10-40-Kafka/Untitled%2020.png)

### Kafka Consumer ë™ì‘ í™•ì¸

```jsx
{
  "schema": {
    "type": "struct",
    "fields": [
      {
        "type": "int32",
        "optional": false,
        "field": "id"
      },
      {
        "type": "string",
        "optional": false,
        "field": "name"
      },
      {
        "type": "string",
        "optional": false,
        "field": "email"
      },
      {
        "type": "int32",
        "optional": true,
        "field": "age"
      },
      {
        "type": "string",
        "optional": true,
        "field": "__deleted"
      }
    ],
    "optional": false,
    "name": "dbserver1.sourcedb.users.Value"
  },
  "payload": {
    "id": 1,
    "name": "Ham",
    "email": "tomy8964@naver.com",
    "age": 25,
    "__deleted": "false"
  }
}
```

### Sink_DB_1(MySQL)ì— ë°ì´í„° ì‚½ì… ë°˜ì˜ í™•ì¸

![Untitled](/assets/img/2023-10-40-Kafka/Untitled%2021.png)

### Sink_DB_2(PostgreSQL)ì— ë°ì´í„° ì‚½ì… ë°˜ì˜ í™•ì¸

![Untitled](/assets/img/2023-10-40-Kafka/Untitled%2022.png)

## ë°ì´í„° ìˆ˜ì •

### Source_DB(MySQL)ì—ì„œ ë°ì´í„° ìˆ˜ì •

![Untitled](/assets/img/2023-10-40-Kafka/Untitled%2023.png)

### Kafka Consumer ë™ì‘ í™•ì¸

```jsx
{
  "schema": {
    "type": "struct",
    "fields": [
      {
        "type": "int32",
        "optional": false,
        "field": "id"
      },
      {
        "type": "string",
        "optional": false,
        "field": "name"
      },
      {
        "type": "string",
        "optional": false,
        "field": "email"
      },
      {
        "type": "int32",
        "optional": true,
        "field": "age"
      },
      {
        "type": "string",
        "optional": true,
        "field": "__deleted"
      }
    ],
    "optional": false,
    "name": "dbserver1.sourcedb.users.Value"
  },
  "payload": {
    "id": 1,
    "name": "John",
    "email": "john@gmail.com",
    "age": 25,
    "__deleted": "false"
  }
}
```

### Sink_DB_1(MySQL)ì— ë°ì´í„° ìˆ˜ì • ë°˜ì˜ í™•ì¸

![Untitled](/assets/img/2023-10-40-Kafka/Untitled%2024.png)

### Sink_DB_2(PostgreSQL)ì— ë°ì´í„° ìˆ˜ì • ë°˜ì˜ í™•ì¸

![Untitled](/assets/img/2023-10-40-Kafka/Untitled%2025.png)

## ë°ì´í„° ì‚­ì œ

### Source_DB(MySQL)ì—ì„œ ë°ì´í„° ì‚­ì œ

![Untitled](/assets/img/2023-10-40-Kafka/Untitled%2026.png)

![Untitled](/assets/img/2023-10-40-Kafka/Untitled%2027.png)

### Kafka Consumer ë™ì‘ í™•ì¸

```jsx
{
  "schema": {
    "type": "struct",
    "fields": [
      {
        "type": "int32",
        "optional": false,
        "field": "id"
      },
      {
        "type": "string",
        "optional": false,
        "field": "name"
      },
      {
        "type": "string",
        "optional": false,
        "field": "email"
      },
      {
        "type": "int32",
        "optional": true,
        "field": "age"
      },
      {
        "type": "string",
        "optional": true,
        "field": "__deleted"
      }
    ],
    "optional": false,
    "name": "dbserver1.sourcedb.users.Value"
  },
  "payload": {
    "id": 1,
    "name": "Ham",
    "email": "tomy8964@naver.com",
    "age": 25,
    "__deleted": "true"
  }
}
```

### Sink_DB_1(MySQL)ì— ë°ì´í„° ì‚­ì œ ë°˜ì˜ í™•ì¸

![Untitled](/assets/img/2023-10-40-Kafka/Untitled%2028.png)

### Sink_DB_2(PostgreSQL)ì— ë°ì´í„° ì‚­ì œ ë°˜ì˜ í™•ì¸

![Untitled](/assets/img/2023-10-40-Kafka/Untitled%2029.png)

## í…Œì´ë¸” ìˆ˜ì •

### Source_DB(MySQL)ì—ì„œ í…Œì´ë¸” ìˆ˜ì •

![Untitled](/assets/img/2023-10-40-Kafka/Untitled%2030.png)

### Kafka Consumer ë™ì‘ í™•ì¸

```jsx
{
  "schema": {
    "type": "struct",
    "fields": [
      {
        "type": "int32",
        "optional": false,
        "field": "id"
      },
      {
        "type": "string",
        "optional": false,
        "field": "name"
      },
      {
        "type": "string",
        "optional": false,
        "field": "email"
      },
      {
        "type": "int32",
        "optional": true,
        "field": "age"
      },
      {
        "type": "string",
        "optional": true,
        "field": "home"
      },
      {
        "type": "string",
        "optional": true,
        "field": "__deleted"
      }
    ],
    "optional": false,
    "name": "dbserver1.sourcedb.users.Value"
  },
  "payload": {
    "id": 1,
    "name": "Ham",
    "email": "tomy8964@naver.com",
    "age": 25,
    "home": "Seoul",
    "__deleted": "false"
  }
}
```

### Sink_DB_1(MySQL)ì— í…Œì´ë¸” ìˆ˜ì • ë°˜ì˜ í™•ì¸

![Untitled](/assets/img/2023-10-40-Kafka/Untitled%2031.png)

### Sink_DB_2(PostgreSQL)ì— í…Œì´ë¸” ìˆ˜ì • ë°˜ì˜ í™•ì¸

![Untitled](/assets/img/2023-10-40-Kafka/Untitled%2032.png)