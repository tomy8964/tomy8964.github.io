---
title: MSA
date: YYYY-MM-DD HH:MM:SS +09:00
categories: [ë°±ì—”ë“œ, MSA]
tags:
  [
    Spring,
    ë°±ì—”ë“œ,
    MSA
  ]

toc: true
toc_sticky: true

---
# MSA

# MSA Basic

Microservice Architecture

![image](https://github.com/tomy8964/Spring-Study/assets/103511161/cfb0ba34-a441-439f-b668-f5b4c8b89d6a)

ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ê¸°ëŠ¥ë³„ë¡œ ë‚˜ëˆ„ê³  ì—¬ëŸ¬ ì„œë¹„ìŠ¤ë¡œ ë§Œë“­ë‹ˆë‹¤.

ì„œë¹„ìŠ¤ ê°„ì— ì •ë³´ë¥¼ ê³µìœ í•˜ê³  í†µí•© ê¸°ëŠ¥ì„ ìˆ˜í–‰í•˜ëŠ” ê¸°ìˆ ì…ë‹ˆë‹¤.

- ê°„í¸í•œ ì¥ì•  ê²©ë¦¬ ë° ë³µêµ¬
- ë¹„ìš© íš¨ìœ¨ì ì¸ í™•ì¥ì„±
- ì½”ë“œ í¬ê¸°ê°€ ì‘ê³  ìœ ì§€ë³´ìˆ˜ê°€ ìš©ì´í•˜ì—¬ ìƒì‚°ì„± í–¥ìƒ
- ì‹ ì†í•œ êµ¬í˜„ ë° êµ¬í˜„ìœ¼ë¡œ ì„œë¹„ìŠ¤ ê°œì„  ì†ë„ í–¥ìƒ
- ê° ì„œë¹„ìŠ¤ì— ëŒ€í•´ ìµœì í™”ëœ ê°œë°œ ì–¸ì–´ ë° DB ì„ íƒ ê°€ëŠ¥

> MSAëŠ” í´ë¼ìš°ë“œ ë„¤ì´í‹°ë¸Œ í™˜ê²½ì˜ í•µì‹¬ ê¸°ìˆ  ì¤‘ í•˜ë‚˜ ì…ë‹ˆë‹¤.
> 

## Spring Cloud

Spring CloudëŠ” ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ì˜ ê°œë°œ, ë°°í¬, ìš´ì˜ì— í•„ìš”í•œ ì•„í‚¤í…ì²˜ë¥¼ ì‰½ê²Œ êµ¬ì„±í•  ìˆ˜ ìˆë„ë¡ ì§€ì›í•˜ëŠ” Spring Boot ê¸°ë°˜ì˜ í”„ë ˆì„ì›Œí¬

![image](https://github.com/tomy8964/Spring-Study/assets/103511161/9041f61c-30e1-4026-b33c-dfac983ccac7)

## Cloud Native

í´ë¼ìš°ë“œ ì»´í“¨íŒ… ëª¨ë¸ì„ ìµœëŒ€í•œ í™œìš©í•˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ê°œë°œ, êµ¬ì¶• ë° ì‹¤í–‰í•˜ê¸° ìœ„í•œ ë°©ë²•ë¡ ì…ë‹ˆë‹¤. 

ì• í”Œë¦¬ì¼€ì´ì…˜ ì•„í‚¤í…ì²˜ë¥¼ ì„¤ê³„ ì‹œì ë¶€í„° í´ë¼ìš°ë“œ í™˜ê²½ì— ë§ê²Œ ì„¤ê³„í•˜ì—¬ í´ë¼ìš°ë“œ í™˜ê²½ì— ëŒ€í•œ ì˜ì¡´ì„±ì„ ì œê±°í•˜ëŠ” ê²ƒì´ ê·¸ ëª©ì ì…ë‹ˆë‹¤.

![image](https://github.com/tomy8964/Spring-Study/assets/103511161/562d350a-7b8f-4cc7-9da9-47ab5b7b3b19)

- **DevOps**: ì†Œí”„íŠ¸ì›¨ì–´ ê°œë°œê³¼ ìš´ì˜ì˜ í•©ì„±ì–´ë¡œ ì†Œí”„íŠ¸ì›¨ì–´ ê°œë°œìì™€ ì •ë³´ê¸°ìˆ  ì „ë¬¸ê°€ ê°„ì˜ ì†Œí†µ, í˜‘ì—…, í†µí•©ì„ ê°•ì¡°í•˜ëŠ” ê°œë°œ í™˜ê²½ì´ë‚˜ ë¬¸í™”ë¥¼ ë§í•©ë‹ˆë‹¤.
- **ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤**: ë‹¤ìŒì˜ ì¡°í•©ìœ¼ë¡œ ë‹¨ì¼ í”„ë¡œê·¸ë¨ì„ êµ¬ì¶•í•˜ëŠ” ë°©ë²• ì†Œê·œëª¨ ì„œë¹„ìŠ¤ë¥¼ ê°œë³„ êµ¬ì„±ìš”ì†Œë¡œ ì„¸ë¶„í™”í•©ë‹ˆë‹¤.
- **ì»¨í…Œì´ë„ˆ**: ì‘ìš© í”„ë¡œê·¸ë¨ ì½”ë“œì™€ í•¨ê»˜ íŠ¹ì • ë²„ì „ì˜ í”„ë¡œê·¸ë˜ë° ì–¸ì–´ ëŸ°íƒ€ì„ ë° ì†Œí”„íŠ¸ì›¨ì–´ ì„œë¹„ìŠ¤ë¥¼ ì‹¤í–‰í•˜ëŠ” ë° í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í¬í•¨í•˜ëŠ” ê²½ëŸ‰ íŒ¨í‚¤ì§€ì…ë‹ˆë‹¤.
- **CI/CD**: ì§€ì†ì ì¸ í†µí•© ë° ì§€ì†ì ì¸ ì œê³µ. í†µí•© ë° í…ŒìŠ¤íŠ¸ ë‹¨ê³„ì—ì„œ ì œê³µ ë° ë°°í¬ì— ì´ë¥´ê¸°ê¹Œì§€ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë¼ì´í”„ì‚¬ì´í´ ì „ë°˜ì— ê±¸ì³ ì§€ì†ì ì¸ ìë™í™” ë° ì§€ì†ì ì¸ ëª¨ë‹ˆí„°ë§ì„ ì œê³µí•©ë‹ˆë‹¤.

# Practice

## Project Structure

![image](https://github.com/tomy8964/Spring-Study/assets/103511161/49138342-90c7-499a-b48b-d7a72647e800)

## Member Service

MemberService ì‘ìš© í”„ë¡œê·¸ë¨ì„ í´ë¼ì´ì–¸íŠ¸ ì„œë¹„ìŠ¤ë¡œ ë“±ë¡í•˜ê³  ë©¤ë²„ ë„ë©”ì¸ ì»¨íŠ¸ë¡¤ëŸ¬ê°€ RESTful ìš”ì²­ì„ ì²˜ë¦¬í•˜ë„ë¡ í•©ë‹ˆë‹¤.

### project structure

![image](https://github.com/tomy8964/Spring-Study/assets/103511161/993ca476-91eb-4b92-8f1c-8e5e876507e8)

- **MemberServiceApplication**: Spring Boot ì‘ìš© í”„ë¡œê·¸ë¨ìœ¼ë¡œ ì„œë¹„ìŠ¤ë¥¼ Eureka ì„œë²„ì— í´ë¼ì´ì–¸íŠ¸ë¡œ ë“±ë¡í•©ë‹ˆë‹¤.
- **Member**: ë©¤ë²„í´ë˜ìŠ¤ ë„ë©”ì¸.
- **MemberConroller**: HTTP ìš”ì²­ì„ ì²˜ë¦¬í•  ì»¨íŠ¸ë¡¤ëŸ¬ ë° ë§¤í•‘
ë°©ë²•ì„ ì§€ì •í•©ë‹ˆë‹¤.
- **applicaion.yml**: ì„œë²„ í¬íŠ¸ ë²ˆí˜¸, ì„œë¹„ìŠ¤ ì´ë¦„ ë° Eureka ì„œë²„ ì •ë³´ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.

### MemberService Dependency

`pom.xml`

```java
...
<dependency>
	<groupId>org.springframework.boot</groupId>
	<artifactId>spring-boot-starter-web</artifactId>
</dependency>
<dependency>
	<groupId>org.springframework.cloud</groupId>
	<artifactId>spring-cloud-starter-netflix-eureka-client
	</artifactId>
</dependency>
<dependency>
	<groupId>org.projectlombok</groupId>
	<artifactId>lombok</artifactId>
	<optional>true</optional>
</dependency>
```

ğŸ’¡ MSA í™˜ê²½ì—ì„œëŠ” ë™ì ìœ¼ë¡œ IPì™€ í¬íŠ¸ë²ˆí˜¸ë¥¼
ì§€ì •í•˜ë¯€ë¡œ ì§€ì†ì ìœ¼ë¡œ ë³€ê²½ë©ë‹ˆë‹¤. 

MSA í™˜ê²½ì—ì„œ ì„œë¹„ìŠ¤ ì •ë³´ë¥¼ ë“±ë¡í•˜ê³  ê´€ë¦¬í•˜ë„ë¡ ì§€ì›í•©ë‹ˆë‹¤.


### MemberServiceApplication.java

```java
@SpringBootApplication
@EnableDiscoveryClient
public class MemberServiceApplication {

    public static void main(String[] args) {
        SpringApplication.run(MemberServiceApplication.class, args);
    }

}
```

> DiscoveryClientë¡œ ë“±ë¡

### Member.java

```java
@Data
@AllArgsConstructor
public class Member {

    private Long id;
    private String name;
    private String password;

}
```

### MemberController.java

```java
@RestController
public class MemberController {
    @GetMapping("/api/member")
    public Member getMember() {
        return new Member(1L, "Gachon", "gcu");
    }
}
```

### resources/application.yml

```yaml
server:
  port: 8081

spring:
  application:
    name: memberservice

eureka:
  instance:
    preferIpAddress: true
    lease-renewal-interval-in-seconds: 30
  client:
    registerWithEureka: true
    fetchRegistry: true
    serviceUrl:
      defaultZone: http://127.0.0.1:8761/eureka/
```

ğŸ’¡ ì„œë²„ í¬íŠ¸ ë²ˆí˜¸ë¥¼ 8081ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.

**preferIpAddress**: ì„œë¹„ìŠ¤ ê°„ í†µì‹  ì‹œ IPê°€ ë¨¼ì € ì‚¬ìš©ë©ë‹ˆë‹¤.

**lease-renewal-interval-inseconds** : 30ì´ˆë§ˆë‹¤ í•˜íŠ¸ë¹„íŠ¸ ì „ì†¡

**registerWithEureka**: ì„œë¹„ìŠ¤ê°€ Eurekaì— ë“±ë¡ë˜ë„ë¡ ì§€ì •

**fetchRegistry**: í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ì˜ ë“±ë¡ëœ ì¸ìŠ¤í„´ìŠ¤ ëª©ë¡ì„ ìºì‹œ í•˜ì§€ ì•Šë„ë¡ ì§€ì •í•©ë‹ˆë‹¤.

**defaultZone**: ë™ì¼í•œ ì˜ì—­ì—ì„œ ìœ ë ˆì¹´ ì„œë²„ í´ëŸ¬ìŠ¤í„°ë§ êµ¬ì„±

## Order Service

OrderService ì‘ìš© í”„ë¡œê·¸ë¨ì„ HTTP í´ë¼ì´ì–¸íŠ¸ ì„œë¹„ìŠ¤(FeignClient)ë¡œ ë“±ë¡í•˜ê³  êµ¬ì„±ì› ì„œë¹„ìŠ¤ë¥¼ Feign í´ë¼ì´ì–¸íŠ¸ë¡œ ë“±ë¡í•©ë‹ˆë‹¤. HTTP ìš”ì²­ ë§¤í•‘ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

### Project Structure


![image](https://github.com/tomy8964/Spring-Study/assets/103511161/a95c6702-d658-4c62-996b-2ecba6677619)

- OrderServiceApplication: Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ìœ¼ë¡œ ì„œë¹„ìŠ¤ë¥¼ Eureka ì„œë²„ì— HTTP í´ë¼ì´ì–¸íŠ¸(Feign)ë¡œ ë“±ë¡í•©ë‹ˆë‹¤.
- **Member**: ë©¤ë²„ í´ë˜ìŠ¤ ë„ë©”ì¸
- **MemberServiceFeignClient**: feign í´ë¼ì´ì–¸íŠ¸ë¡œ memberservice ë“±ë¡
- **OrderController**: ì¢…ì†ì„± ì£¼ì…ì„ í†µí•´ Feign í´ë¼ì´ì–¸íŠ¸ì˜ ê°œì²´ ë³€ìˆ˜ë¥¼ ë§Œë“¤ê³  HTTP ìš”ì²­ì„ ë§¤í•‘í•©ë‹ˆë‹¤.
- **applicaion.yml**: ì„œë²„ í¬íŠ¸ ë²ˆí˜¸, ì„œë¹„ìŠ¤ ì´ë¦„, Eureka ì„œë²„ ì •ë³´ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.

### OrderService Dependency

`pom.xml`

```yaml
...
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-web</artifactId>
</dependency>
<dependency>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-starter-netflix-eureka-client
  </artifactId>
</dependency>
<dependency>
  <groupId>org.projectlombok</groupId>
  <artifactId>lombok</artifactId>
  <optional>true</optional>
</dependency>
<dependency>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```


ğŸ’¡ **openfeingn**: ì›ë˜ Netflixì—ì„œ ë§Œë“  ì„ ì–¸ì 
HTTP í´ë¼ì´ì–¸íŠ¸ ë„êµ¬ë¡œ ì™¸ë¶€ API í˜¸ì¶œì„ ì‰½ê²Œ í•  ìˆ˜
ìˆë„ë¡ ë„ì™€ì¤ë‹ˆë‹¤. MSA í†µì‹ ì œê³µ


### OrderServiceApplication.java

```java
@SpringBootApplication
@EnableFeignClients
public class OrderServiceApplication {

    public static void main(String[] args) {
        SpringApplication.run(OrderServiceApplication.class, args);
    }
}
```

> `@EnableFeignClients` : Netflixì—ì„œ ê°œë°œí•œ Http
í´ë¼ì´ì–¸íŠ¸ì…ë‹ˆë‹¤. HTTP ìš”ì²­ì„ ì‰½ê²Œ ìƒì„±í•˜ê³  ë³´ë‚¼
ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” ê°ì²´ì…ë‹ˆë‹¤.

### Member.java

```java
@Data
public class Member {
	private Long id;
	private String name; 
	private String password;
}
```

### MemberServiceFeighClient.java

```java
@FeignClient("memberservice")
public interface MemberServiceFeignClient {
        @GetMapping(value = "/api/member", consumes = "application/json")
        Member getMember();
}
```

> `@FeignClient("members
ervice")`: memberservice ì´ë¦„ì˜ í˜ì¸íŠ¸ í´ë¼ì´ì–¸íŠ¸ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.

ì¸í„°í˜ì´ìŠ¤ ì •ì˜

/api/member ê²½ë¡œê°€ í¬í•¨ëœ GET ìš”ì²­ì´ ì˜¤ë©´ getMemberê°€ í˜¸ì¶œë˜ì–´ Member ê°ì²´ë¥¼ json í˜•ì‹ìœ¼ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤.

### OrderController.java

```java
@RestController
public class OrderController {
    @Autowired
    private MemberServiceFeignClient memberServiceFeignClient;

    @GetMapping("/api/order")
    public String order() {
        return memberServiceFeignClient.getMember().getName() + " requested an order.";
    }
}
```

> FeinClient ê°ì²´ë³€ìˆ˜ë¥¼ í†µí•´ ë©¤ë²„ì´ë¦„ì„ Orderì„œë¹„ìŠ¤ì—ì„œ ê°€ì ¸ì™€ì„œ ì¶œë ¥í•©ë‹ˆë‹¤.

### application.yml

```yaml
server:
  port: 8082

spring:
  application:
    name: orderservice

eureka:
  instance:
    preferIpAddress: true
    lease-renewal-interval-in-seconds: 30

  client:
    registerWithEureka: true
    fetchRegistry: true
    serviceUrl:
      defaultZone: http://127.0.0.1:8761/eureka/
```

## Eureka Server

ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ë¥¼ ë“±ë¡í•˜ê³  ì¥ì•  ê°ì§€ë¥¼ ìœ„í•´ ë„·í”Œë¦­ìŠ¤ì˜ ìœ ë ˆì¹´ ì„œë²„ë¥¼ êµ¬ì¶•í•©ë‹ˆë‹¤.

### EurekaServerApplication.java

```java
@SpringBootApplication
@EnableEurekaServer
public class EurekaServerApplication {

    public static void main(String[] args) {
        SpringApplication.run(EurekaServerApplication.class, args);
    }
}
```

> EurekaServerë¥¼ ê²€ìƒ‰ ì„œë²„ë¡œ ë“±ë¡

### application.yml

```yaml
server:
  port: 8761

eureka:
  instance:
    hostname: localhost
  client:
    registerWithEureka: false
    fetchRegistry: false
  server:
    serverUrl:
      defaultZone: http://127.0.0.1:8761/eureka/
```

> ì„œë²„ í¬íŠ¸ ë²ˆí˜¸ë¥¼ 8761ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
Eureka ì„œë²„ì˜ ê¸°ë³¸ í¬íŠ¸ ë²ˆí˜¸ì…ë‹ˆë‹¤.

- ì„œë¹„ìŠ¤ê°€ Eurekaì— ë“±ë¡ë˜ì§€ ì•Šë„ë¡ ì§€ì •í•˜ì‹­ì‹œì˜¤.
- í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ì˜ ë“±ë¡ëœ ì¸ìŠ¤í„´ìŠ¤ ëª©ë¡ì„ ìºì‹œí•˜ì§€ ì•Šë„ë¡ ì§€ì •í•©ë‹ˆë‹¤.
- ë™ì¼í•œ ì˜ì—­ì—ì„œ ìœ ë ˆì¹´ ì„œë²„ í´ëŸ¬ìŠ¤í„°ë§ êµ¬ì„±

![image](https://github.com/tomy8964/Spring-Study/assets/103511161/bc987efb-1345-4414-be0b-b42b2a867ab7)

## API Gateway

API Gatewayë¥¼ í†µí•´ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ì˜ ë¼ìš°íŒ…ì„ ê´€ë¦¬í•˜ê³  ì¸ì¦ ë° ë³´ì•ˆì— ëŒ€í•œ ê¸°ëŠ¥ì„ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### API Gateway Platform

![image](https://github.com/tomy8964/Spring-Study/assets/103511161/3f837653-ebf4-4d53-8692-73e8f4d276e8)

> êµ¬ì„±ì€ í¬ê²Œ GATEWAY, EUREKA, FALLBACKSERVER, ADMIN, DB, CONFIG-SERVER ë° GITë¡œ êµ¬ì„±ë©ë‹ˆë‹¤.

- **ê²Œì´íŠ¸ì›¨ì´** - ì‹¤ì œ ë¼ìš°íŒ… ë˜ëŠ” ëª¨ë‹ˆí„°ë§ì„ ë‹´ë‹¹í•˜ëŠ” ê²Œì´íŠ¸ì›¨ì´
- **Eureka ì„œë²„**- ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ë¥¼ ê²€ìƒ‰í•˜ëŠ” ì„œë²„ì…ë‹ˆë‹¤.ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ì˜ IP ë° í¬íŠ¸ ë²ˆí˜¸ë¥¼ ë“±ë¡í•˜ê³  ì œê³µí•©ë‹ˆë‹¤.
- **í´ë°± ì„œë²„** - ì‹¤íŒ¨í•œ ìš”ì²­ì— ëŒ€í•œ í´ë°± ì‘ë‹µì„ ì œê³µí•˜ëŠ” ì„œë²„
- **êµ¬ì„± ì„œë²„** - ê²Œì´íŠ¸ì›¨ì´ êµ¬ì„± ì •ë³´ë¥¼ ë™ì ìœ¼ë¡œ ë³€ê²½í•˜ê¸° ìœ„í•œ ìš”ì†Œ

### APT Gateway

SCG(Spring Cloud Gateway)ë¥¼ í†µí•œ ì—¬ëŸ¬ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ì˜ ë¼ìš°íŒ…ì„ ì§€ì›í•©ë‹ˆë‹¤.
* `implementation 'org.springframework.cloud:spring-cloud-starter-gateway'`
* `implementation 'org.springframework.cloud:spring-cloud-starter-netflix-eureka-client'`

### GatewayApplication.java

```java
@SpringBootApplication
@EnableDiscoveryClient
public class GcuGatewayApplication {
    public static void main(String[] args) {
        SpringApplication.run(GcuGatewayApplication.class, args);
    }
}
```

### application.yml

```yaml
server:
  port: 8000

eureka:
  client:
    register-with-eureka: true
    fetch-registry: true
    service-url:
      defaultZone: http://localhost:8761/eureka

spring:
  application:
    name: apigateway-service
  cloud:
    gateway:
      routes:
        - id: memberservice
          uri: http://localhost:8081/
          predicates:
            - Path=/api/member/**
        - id: orderservice
          uri: http://localhost:8082/
          predicates:
            - Path=/api/order/**
```

![image](https://github.com/tomy8964/Spring-Study/assets/103511161/2669ac12-0fe9-4321-9bb0-8d0c8422cfb2)

----
References: ê°€ì²œ SW ì•„ì¹´ë°ë¯¸